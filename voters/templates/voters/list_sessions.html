<!-- templates/voting/list_voting_sessions.html -->
<head>
    <meta charset="UTF-8">
    <title>Voting Sessions</title>
    {% load static %}
    <link href="{% static 'style.css' %}?v={% now 'U' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="{% static 'qr_modal.js' %}" defer></script>
</head>

<nav class="admin-navbar">
    <div class="navbar-content">
        <h2 class="admin-title">Voting Sessions</h2>
        <div class="profile">
            <ul>
                <h2 class="page-title"></h2>
            </ul>
        </div>
    </div>
</nav>

<!-- Flash message section -->
{% if messages %}
    <div class="flash-alert" id="flash-alert">
        {% for message in messages %}
            <p class="flash-message {{ message.tags }}">{{ message }}</p>
        {% endfor %}
    </div>
{% endif %}

<form class="create_session_form" method="POST" action="{% url 'list_voting_sessions' %}">
    {% csrf_token %}
    <div class="session-form-row">
        {{ form.title }}
        <button class="create-session-btn" type="submit">Create New Session</button>
    </div>
</form>

    
    
    <div class="session-list">
        {% for session in sessions %}
            <div class="session-card" onclick="window.location.href='{% url 'active_voting_session' session.session_id %}'">
                <div class="session-info">
                    <a href="{% url 'active_voting_session' session.session_id %}" class="session-title">{{ session.title }}</a>
                    <div class="session-links">
                        <div class="session-links__stack">
                            <div class="session-link-switcher" onclick="event.stopPropagation();">
                                <div class="session-link-switcher__tabs">
                                    <button type="button" class="link-tab is-active" data-link-tab="vote" aria-controls="uuid-display-{{ session.session_id }}">Vote link</button>
                                    <button type="button" class="link-tab" data-link-tab="register" aria-controls="uuid-display-{{ session.session_id }}">Registration link</button>
                                </div>
                                <div class="session-link-switcher__body">
                                    <span
                                        class="session-uuid-display session-link-value"
                                        id="uuid-display-{{ session.session_id }}"
                                        data-vote-url="{{ session.share_url|default:'' }}"
                                        data-register-url="{{ session.registration_url|default:'' }}"
                                    >
                                        {{ session.share_url|default:"Link not ready" }}
                                    </span>
                                    <button
                                        type="button"
                                        class="session-copy-trigger"
                                        data-copy-target="uuid-display-{{ session.session_id }}"
                                        aria-label="Copy session link"
                                        onclick="event.stopPropagation();"
                                    >
                                        <i class="bi bi-clipboard"></i>
                                        <span class="session-copy-tooltip" role="status" aria-live="polite">Copied</span>
                                    </button>
                                </div>
                            </div>
                            <div class="session-actions">
                                <a
                                    href="{% url 'qr_png' session.session_uuid %}"
                                    class="action-bubble"
                                    data-qr-modal="{% url 'qr_png' session.session_uuid %}"
                                    data-qr-label="{{ session.title }} QR Code"
                                    onclick="event.stopPropagation();"
                                >QR Code</a>
                                <a
                                    href="{% url 'voter_list' session.session_id %}"
                                    class="action-bubble"
                                    onclick="event.stopPropagation();"
                                >
                                    Manage Voters
                                </a>
                                <a
                                    href="{% url 'delete_voting_session' session.session_id %}"
                                    class="delete-link"
                                    onclick="event.stopPropagation();"
                                >
                                    Delete
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const flashAlert = document.getElementById('flash-alert');
        if (flashAlert) {
            setTimeout(() => {
                flashAlert.style.opacity = '0';
                setTimeout(() => {
                    flashAlert.style.display = 'none';
                }, 600); // Wait for the fade-out effect
            }, 5000); // Message will disappear after 5000 milliseconds (5 seconds)
        }

        const copyButtons = document.querySelectorAll('.session-copy-trigger');
        copyButtons.forEach((button) => {
            button.addEventListener('click', async () => {
                const targetId = button.getAttribute('data-copy-target');
                const contentEl = targetId ? document.getElementById(targetId) : null;
                const textToCopy = contentEl ? contentEl.textContent.trim() : '';
                if (!textToCopy) {
                    return;
                }
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    button.classList.add('is-copied');
                    setTimeout(() => button.classList.remove('is-copied'), 1600);
                } catch (err) {
                    console.error('Unable to copy UUID', err);
                }
            });
        });

        const linkSwitchers = document.querySelectorAll('.session-link-switcher');
        linkSwitchers.forEach((switcher) => {
            const valueEl = switcher.querySelector('.session-link-value');
            const tabs = switcher.querySelectorAll('.link-tab');
            tabs.forEach((tab) => {
                tab.addEventListener('click', (event) => {
                    event.stopPropagation();
                    tabs.forEach(t => t.classList.remove('is-active'));
                    tab.classList.add('is-active');
                    const target = tab.dataset.linkTab;
                    const url = valueEl ? valueEl.dataset[`${target}Url`] : '';
                    if (valueEl) {
                        valueEl.textContent = url || 'Link not ready';
                    }
                });
            });
        });

        const getCsrfToken = () => {
            const meta = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (meta && meta.value) {
                return meta.value;
            }
            const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
            return match ? decodeURIComponent(match[1]) : '';
        };

    });
</script>
<script>
  // Force reload when page is restored from back/forward cache
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
      window.location.reload();
    }
  });
</script>
