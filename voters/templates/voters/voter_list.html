<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token_value|default:csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'style.css' %}?v={% now 'U' %}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Voter List</title>
    
    <script src="{% static 'deactivate_button.js' %}" defer></script>
    <script src="{% static 'qr_modal.js' %}" defer></script>
</head>

<nav class="voting_session-navbar">
    <div class="voting_session-navbar-content">


        <!-- Navbar stats -->
        <div class="final-navbar">
            <div>
                <p>Verified Voters: {{ verified_voters_count }}/{{ total_voters_count }}</p>
                <p>Finished Voters: {{ finished_voters_count }}/{{ total_voters_count }}</p>
            </div>
        </div>


        <!-- Voting session title -->
        <h1 style="align-items: center;" class="voting_session-navbar-title">{{ voting_session.title }} - Voting Session</h1>

        

        <!-- Hamburger menu icon for mobile view -->
        <div class="voting_session-navbar-toggle" onclick="toggleNavbar()" aria-controls="voting-session-links" aria-expanded="false" role="button" tabindex="0">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- Navbar links -->
        <div class="voting_session-navbar-links" id="voting-session-links">
            <ul>
                <li id="generate-results-nav" {% if not voting_session.is_active %}hidden{% endif %}>
                    <a
                        class="generate-results-link"
                        id="generate-results-link"
                        href="{% url 'bbs_results' session_uuid %}"
                        data-results-url="{% url 'bbs_results' session_uuid %}"
                    >Generate Results</a>
                </li>
                {% if voting_session.is_active %}
                <li>
                    <button
                        class="hold-button is-complete"
                        id="holdBtn"
                        type="button"
                        data-is-active="true"
                        data-session-id="{{ voting_session.session_id }}"
                        data-session-uuid="{{ voting_session.get_uuid }}"
                        data-session-title="{{ voting_session.title }}"
                        data-unique-url="{{ voting_session.unique_url|default_if_none:'' }}"
                        data-qr-code-url="{% url 'qr_png' voting_session.session_uuid %}"
                        disabled
                    >
                        <div class="hold-progress" id="progressBar"></div>
                        <span>Session Active</span>
                    </button>
                </li>
                {% else %}
                <li>
                    <button
                        class="hold-button"
                        id="holdBtn"
                        type="button"
                        data-activate-url="{% url 'activate_session' voting_session.session_id %}"
                        data-session-id="{{ voting_session.session_id }}"
                        data-session-uuid="{{ voting_session.get_uuid }}"
                        data-session-title="{{ voting_session.title }}"
            data-unique-url="{{ voting_session.unique_url|default_if_none:'' }}"
            data-qr-code-url="{% url 'qr_png' voting_session.session_uuid %}"
            data-is-active="false"
                    >
                        <div class="hold-progress" id="progressBar"></div>
                        <span>Hold to Activate</span>
                    </button>
                </li>
                {% endif %}
                {% if request.user.is_staff %}
                <li>
                    <a href="{% url 'manual_check_page' session_uuid %}">Manual Check</a>
                </li>
                {% endif %}
                <li><a href="{% url 'list_voting_sessions' %}">List Sessions</a></li>
            </ul>
        </div>
    </div>
</nav>

<body>
    <script>
        // Mobile navbar toggle (hamburger)
        function toggleNavbar() {
            const links = document.querySelector('.voting_session-navbar-links');
            const toggle = document.querySelector('.voting_session-navbar-toggle');
            if (!links) return;
            const isOpen = links.classList.toggle('active');
            if (toggle) toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        window.csrfToken = "{{ csrf_token_value|default:csrf_token|escapejs }}";
    </script>
    <section class="session-activation-panel">
        <div
            id="activationMessage"
            class="session-activation-message{% if not voting_session.is_active %} is-idle{% endif %}"
            data-active="{{ voting_session.is_active|yesno:'true,false' }}"
            data-idle-text="Activate the session to generate a shareable link and QR code."
            data-active-text="Voting session is active."
            data-unique-url="{{ voting_session.unique_url|default_if_none:'' }}"
            data-qr-code-url="{% url 'qr_png' voting_session.session_uuid %}"
            data-session-title="{{ voting_session.title }}"
        >
            {% if voting_session.is_active %}
                <span class="status-dot"></span>
                Voting session is active.
                <span class="activation-links">
                    {% if voting_session.unique_url %}
                        <a class="activation-link" href="{{ voting_session.unique_url }}" target="_blank" rel="noopener">Open Share Link</a>
                    {% endif %}
                    <a
                        class="activation-link"
                        href="{% url 'qr_png' voting_session.session_uuid %}"
                        target="_blank"
                        rel="noopener"
                        data-qr-modal="{% url 'qr_png' voting_session.session_uuid %}"
                        data-qr-label="{{ voting_session.title }} QR Code"
                    >View QR Code</a>
                </span>
            {% else %}
                <span class="status-dot is-idle"></span>
                Activate the session to generate a shareable link and QR code.
            {% endif %}
        </div>
    </section>
    <!-- Parent Container for Flexbox Layout -->
    <div class="voter-management-container">
            <!-- Create Voter Form -->
            <div class="voter-form-column">
                <h2>Create Voter</h2>
                <form id="add-voter-form" method="POST" 
                    action="{% if session_id %}{% url 'voter_list' session_id %}{% elif session_uuid %}{% url 'voter_list' session_uuid=voting_session.get_uuid %}{% endif %}">
                    {% csrf_token %}
                    <p>{{ form.Fname }}</p>
                    <p>{{ form.Lname }}</p>
                    <button type="submit" id="add-voter-button">Add Voter</button>
                </form>
            </div>

            <!-- Search Bar -->
            <div class="search-bar-column">
                <form method="GET" action="" class="search-form">
                    <div class="search-input-container">
                        <input type="text" name="search" placeholder="Search by first or last name" value="{{ request.GET.search }}" class="search-input">
                        {% if request.GET.search %}
                            <!-- Clear "X" Button Inside Search Bar -->
                            <button type="button" class="clear-search" onclick="clearSearch()">&#x2715;</button>
                        {% endif %}
                    </div>
                    <button type="submit" class="search-button">Search</button>
                </form>
            </div>

            <!-- Import Voters -->
            <div class="import-column">
                <div class="import-card">
                    <div class="import-card__header">
                        <div>
                            <p class="import-eyebrow">Bulk upload</p>
                            <h3>Import voters</h3>
                        </div>
                        <button type="button" class="pill pill--ghost" onclick="openImportModal(); event.stopPropagation();">
                            <i class="bi bi-upload"></i>
                            Import
                        </button>
                    </div>
                    <p class="import-card__body">
                        Upload CSV or Excel to register voters at scale. Duplicates are skipped automatically.
                    </p>
                    <div class="import-card__actions">
                        <a class="template-link" href="{% url 'voter_template_download' %}" onclick="event.stopPropagation();">
                            Download template
                        </a>
                        <span class="import-hint">Accepted: .csv, .xlsx</span>
                    </div>
                </div>
            </div>

            <!-- Filter Buttons -->
            <div class="filter-buttons-column">
                <div class="filter-header">
                    <!-- Filter icon triggers dropdown on click -->
                    <i class="bi bi-funnel-fill" onclick="toggleDropdown()"></i>
                    <h3>Filters</h3>
                </div>
            
            <!-- Dropdown menu for filter options -->
            <div class="dropdown">
                <!-- Removed the "Select Filter" button -->
                <div class="dropdown-content">
                    <button class="filter-btn" data-filter="verified" onclick="filterVoters('all')">Show All Voters</button>
                    <button class="filter-btn" data-filter="verified" onclick="filterVoters('verified')">Verified Voters</button>
                    <button class="filter-btn" data-filter="not_verified" onclick="filterVoters('not_verified')">Non-Verified Voters</button>
                    <button class="filter-btn" data-filter="verified_finished" onclick="filterVoters('verified_finished')">Verified and Finished Voters</button>
                    <div class="filter-divider"></div>
                    <label class="filter-label" for="sourceFilter">Source</label>
                    <select id="sourceFilter" class="filter-select" onchange="setSourceFilter(this.value)">
                        <option value="all" {% if source_filter == 'all' %}selected{% endif %}>All sources</option>
                        <option value="admin" {% if source_filter == 'admin' %}selected{% endif %}>Admin / Manual</option>
                        <option value="import" {% if source_filter == 'import' %}selected{% endif %}>Import</option>
                        <option value="self" {% if source_filter == 'self' %}selected{% endif %}>Self-registration</option>
                    </select>
                    <label class="filter-label" for="statusFilter">Registration status</label>
                    <select id="statusFilter" class="filter-select" onchange="setRegStatusFilter(this.value)">
                        <option value="all" {% if reg_status_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="approved" {% if reg_status_filter == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="pending" {% if reg_status_filter == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="rejected" {% if reg_status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
            </div>
        </div>

            

            
        </div>

        <!-- Voter List -->
        <table class="voter-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Registration</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="voter-list">
                {% for voter in voters %}
                <tr id="voter-{{ voter.voter_id }}" class="voter-row" data-status="{% if voter.is_verified %}verified{% else %}not_verified{% endif %}">
                    <td style="font-weight: bold;">{{ voter.Fname }} {{ voter.Lname }}</td>
                    <td class="voter-meta-cell">
                        <div class="voter-badges">
                            <span class="badge badge-source badge-source--{{ voter.registration_source|default:'admin' }}">
                                {% if voter.registration_source == 'import' %}Import{% elif voter.registration_source == 'self' %}Self-Registered{% else %}Admin{% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="voter-status-cell">
                        <div class="voter-status">
                        {% if voter.is_verified %}
                            <button type="button"  class = "status-verified">Verified</button>
                            {% if voter.has_finished %}
                                <button type="button"  class = "status-verified"> Finished </button>
                            {% else %}
                                <button type="button" class= "status-not-verified" > Not Finished</button> 
                            {% endif %}
                        {% else %}
                            <button type="button" class= "status-not-verified" > Not Verified </button>
                            <button type="button" class= "status-not-verified" > Not Finished</button> 
                        {% endif %}
                        </div>
                    </td>
                    <td class="voter-actions">
                        {% if not voter.is_verified or not voter.has_finished %}
                        <button
                            type="button"
                            class="delete-voter-btn"
                            data-voter-id="{{ voter.voter_id }}"
                            data-voter-name="{{ voter.Fname }} {{ voter.Lname }}"
                            data-delete-url="{% url 'delete_voter' voter.voter_id %}?{% if session_id %}session_id={{ session_id }}{% else %}session_uuid={{ session_uuid }}{% endif %}"
                            aria-label="Delete {{ voter.Fname }} {{ voter.Lname }}"
                        >
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            
        </table>
    </div>

    <div class="import-modal" id="importModal" aria-hidden="true">
        <div class="import-modal__backdrop" onclick="closeImportModal()" aria-label="Close import modal"></div>
        <div class="import-modal__dialog" role="dialog" aria-modal="true">
            <div class="import-modal__header">
                <div>
                    <p class="import-eyebrow">Bulk upload</p>
                    <h3>Import voters</h3>
                </div>
                <button class="import-modal__close" type="button" onclick="closeImportModal()" aria-label="Close">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <form id="importForm" class="import-form"
                data-import-url="{% if session_uuid %}{% url 'import_voters_uuid' session_uuid %}{% else %}{% url 'import_voters' session_id %}{% endif %}">
                {% csrf_token %}
                <label class="import-file-picker">
                    <span>Select a CSV or Excel file</span>
                    <input type="file" name="file" id="importFile" accept=".csv,.xlsx" required>
                </label>
                <div class="import-progress" id="importProgress" aria-live="polite">
                    <div class="import-progress__bar" id="importProgressBar"></div>
                    <div class="import-progress__label" id="importProgressLabel">Waiting for upload…</div>
                </div>
                <div class="import-modal__actions">
                    <a class="template-link" href="{% url 'voter_template_download' %}" onclick="event.stopPropagation();">Download template</a>
                    <button type="submit" class="pill pill--primary">
                        <i class="bi bi-upload"></i>
                        Start import
                    </button>
                </div>
                <p class="import-footnote">We validate names, skip duplicates, and return a CSV of errors if any rows need review.</p>
            </form>
            <div class="import-summary" id="importSummary" hidden></div>
        </div>
    </div>

    <div id="delete-confirm-card" class="delete-confirm-card" aria-hidden="true">
        <div class="delete-confirm-card__content">
            <p id="delete-card-message"></p>
            <div class="delete-confirm-card__actions">
                <button type="button" id="delete-card-confirm" class="delete-card-confirm">Delete</button>
                <button type="button" id="delete-card-cancel" class="delete-card-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function clearSearch() {
            const url = new URL(window.location.href);
            url.searchParams.delete('search');
            window.location.href = url.toString();
        };

        function toggleDropdown() {
            const dropdownContent = document.querySelector('.dropdown-content');
            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
        }

        // Persist current filter in JS and include it in refresh requests
        let currentFilter = "{{ filter_state|default:'all' }}";
        let currentSourceFilter = "{{ source_filter|default:'all' }}";
        let currentRegStatusFilter = "{{ reg_status_filter|default:'all' }}";

        function filterVoters(status) {
            currentFilter = status || 'all';
            if (typeof window.refreshVoterList === 'function') {
                window.refreshVoterList();
            }
        }

        function setSourceFilter(value) {
            currentSourceFilter = value || 'all';
            if (typeof window.refreshVoterList === 'function') {
                window.refreshVoterList();
            }
        }

        function setRegStatusFilter(value) {
            currentRegStatusFilter = value || 'all';
            if (typeof window.refreshVoterList === 'function') {
                window.refreshVoterList();
            }
        }

        function openImportModal() {
            const modal = document.getElementById('importModal');
            if (modal) {
                modal.classList.add('is-open');
                modal.setAttribute('aria-hidden', 'false');
            }
        }

        function closeImportModal() {
            const modal = document.getElementById('importModal');
            const summary = document.getElementById('importSummary');
            const progressBar = document.getElementById('importProgressBar');
            const progressLabel = document.getElementById('importProgressLabel');
            if (modal) {
                modal.classList.remove('is-open');
                modal.setAttribute('aria-hidden', 'true');
            }
            if (summary) {
                summary.hidden = true;
                summary.innerHTML = '';
            }
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            if (progressLabel) {
                progressLabel.textContent = 'Waiting for upload…';
            }
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        const session_uuid = "{{ session_uuid }}";
        document.addEventListener('DOMContentLoaded', function () {
            const deleteCard = document.getElementById('delete-confirm-card');
            const deleteCardMessage = document.getElementById('delete-card-message');
            const deleteCardConfirm = document.getElementById('delete-card-confirm');
            const deleteCardCancel = document.getElementById('delete-card-cancel');
            let pendingDelete = null;

            function hideDeleteCard() {
                pendingDelete = null;
                if (deleteCard) {
                    deleteCard.classList.remove('is-visible');
                    deleteCard.setAttribute('aria-hidden', 'true');
                }
            }

            function showDeleteCard(voterName, deleteUrl, row) {
                pendingDelete = { deleteUrl, row };
                if (deleteCardMessage) {
                    deleteCardMessage.textContent = `Are you sure you want to delete "${voterName}" before committing the deletion?`;
                }
                if (deleteCard) {
                    deleteCard.classList.add('is-visible');
                    deleteCard.setAttribute('aria-hidden', 'false');
                }
            }

            async function confirmDeletion() {
                if (!pendingDelete || !pendingDelete.deleteUrl) {
                    hideDeleteCard();
                    return;
                }

                try {
                    const response = await fetch(pendingDelete.deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': window.csrfToken,
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok || (data && data.ok === false)) {
                        const errorMessage = (data && data.error) ? data.error : 'Unable to delete voter.';
                        throw new Error(errorMessage);
                    }

                    if (pendingDelete.row) {
                        pendingDelete.row.remove();
                    }

                    hideDeleteCard();
                    refreshVoterList();
                    updateVoterCounts();
                } catch (error) {
                    console.error('Error deleting voter:', error);
                    alert(error.message || 'Unable to delete voter.');
                    hideDeleteCard();
                }
            }

            function attachDeleteHandlers() {
                document.querySelectorAll('.delete-voter-btn').forEach(function (btn) {
                    if (btn.dataset.bound === 'true') {
                        return;
                    }

                    btn.dataset.bound = 'true';
                    btn.addEventListener('click', function () {
                        const voterName = btn.dataset.voterName || 'this voter';
                        const deleteUrl = btn.dataset.deleteUrl;
                        const row = btn.closest('tr');
                        showDeleteCard(voterName, deleteUrl, row);
                    });
                });
            }

            if (deleteCardConfirm) {
                deleteCardConfirm.addEventListener('click', confirmDeletion);
            }
            if (deleteCardCancel) {
                deleteCardCancel.addEventListener('click', hideDeleteCard);
            }
            if (deleteCard) {
                deleteCard.addEventListener('click', function (event) {
                    if (event.target === deleteCard) {
                        hideDeleteCard();
                    }
                });
            }

            // Function to update voter counts in real-time
            function updateVoterCounts() {
                fetch(`/voter_counts/${session_uuid}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update navbar voter counts
                        document.querySelector('.voting_session-navbar p:first-of-type').textContent = `Verified Voters: ${data.verified_voters}/${data.total_voters}`;
                        document.querySelector('.voting_session-navbar p:last-of-type').textContent = `Finished Voters: ${data.finished_voters}/${data.total_voters}`;

                        // Stop updates if all voters are finished
                        if (data.verified_voters === data.total_voters && data.finished_voters === data.total_voters) {
                            console.log("All voters verified and finished. Stopping voter count updates.");
                            clearInterval(voterCountsInterval);
                        }
                    })
                    .catch(error => console.error('Error updating voter counts:', error));
            }

            function refreshVoterList() {
                let searchQuery = "";
                const searchInput = document.querySelector('input[name="search"]');
                if (searchInput) searchQuery = searchInput.value;
                const url = `/get_voter_status/${session_uuid}/?search=${encodeURIComponent(searchQuery)}&filter=${encodeURIComponent(currentFilter)}&source=${encodeURIComponent(currentSourceFilter)}&reg_status=${encodeURIComponent(currentRegStatusFilter)}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const voterList = document.getElementById('voter-list');
                        if (voterList && data.html) {
                            voterList.innerHTML = data.html;
                            attachDeleteHandlers();
                        }

                        // Stop updating if everyone is verified and finished
                        if (
                            data.verified_voters === data.total_voters &&
                            data.finished_voters === data.total_voters
                        ) {
                            console.log("All voters verified and finished. Stopping voter list updates.");
                            clearInterval(voterListInterval);
                        }
                    })
                    .catch(error => console.error("Error refreshing voter list:", error));
            }

            // Example usage: Call this function periodically or on specific events
            const voterListInterval = setInterval(refreshVoterList, 5000); // Refresh every 5 seconds (adjust as needed)

            // Set intervals for real-time updates
            const voterCountsInterval = setInterval(updateVoterCounts, 5000); // Update voter counts every 5 seconds

            // Execute immediately on page load
            updateVoterCounts();
            refreshVoterList();
            attachDeleteHandlers();

            window.refreshVoterList = refreshVoterList;
            window.updateVoterCounts = updateVoterCounts;

            const importForm = document.getElementById('importForm');
            const importSummary = document.getElementById('importSummary');
            const importProgressBar = document.getElementById('importProgressBar');
            const importProgressLabel = document.getElementById('importProgressLabel');

            function downloadErrorCsv(errors) {
                if (!errors || !errors.length) return;
                const rows = [['row', 'error']];
                errors.forEach(err => rows.push([err.row, err.error]));
                const csvContent = rows.map(r => r.map(String).join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'import_errors.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            function renderImportSummary(data) {
                if (!importSummary) return;
                const errors = data.errors || [];
                importSummary.innerHTML = `
                    <div class="import-summary__row"><span>Imported</span><strong>${data.imported || 0}</strong></div>
                    <div class="import-summary__row"><span>Duplicates skipped</span><strong>${data.duplicates || 0}</strong></div>
                    <div class="import-summary__row"><span>Total rows</span><strong>${data.total_rows || 0}</strong></div>
                    <div class="import-summary__row"><span>Errors</span><strong>${data.error_count || 0}</strong></div>
                `;
                if (errors.length) {
                    const preview = errors.slice(0, 3).map(err => `<li>Row ${err.row}: ${err.error}</li>`).join('');
                    importSummary.innerHTML += `
                        <div class="import-summary__errors">
                            <p>${errors.length} row(s) need review.</p>
                            <ul>${preview}</ul>
                            <button type="button" class="pill pill--ghost" id="downloadErrorCsv">Download error CSV</button>
                        </div>
                    `;
                }
                importSummary.hidden = false;

                const downloadBtn = document.getElementById('downloadErrorCsv');
                if (downloadBtn) {
                    downloadBtn.addEventListener('click', function () {
                        downloadErrorCsv(errors);
                    });
                }
            }

            function handleImportSubmit(event) {
                event.preventDefault();
                if (!importForm) return;
                const fileInput = document.getElementById('importFile');
                const file = fileInput?.files?.[0];
                if (!file) {
                    alert('Please choose a CSV or XLSX file to import.');
                    return;
                }

                const url = importForm.dataset.importUrl;
                if (!url) {
                    alert('Import URL missing.');
                    return;
                }

                const fd = new FormData();
                fd.append('file', file);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('X-CSRFToken', window.csrfToken || '');
                xhr.upload.onprogress = function (e) {
                    if (e.lengthComputable && importProgressBar && importProgressLabel) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        importProgressBar.style.width = `${percent}%`;
                        importProgressLabel.textContent = `Uploading… ${percent}%`;
                    }
                };
                xhr.onreadystatechange = function () {
                    if (xhr.readyState !== XMLHttpRequest.DONE) return;
                    if (importProgressLabel) {
                        importProgressLabel.textContent = 'Processing…';
                    }
                    try {
                        const data = JSON.parse(xhr.responseText || '{}');
                        if (!xhr.status || xhr.status >= 400 || data.ok === false) {
                            throw new Error(data.error || 'Import failed.');
                        }
                        if (importProgressBar) {
                            importProgressBar.style.width = '100%';
                        }
                        if (importProgressLabel) {
                            importProgressLabel.textContent = 'Completed';
                        }
                        renderImportSummary(data);
                        if (typeof window.refreshVoterList === 'function') {
                            window.refreshVoterList();
                        }
                        if (typeof window.updateVoterCounts === 'function') {
                            window.updateVoterCounts();
                        }
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Import failed.');
                    }
                };
                xhr.send(fd);
            }

            if (importForm) {
                importForm.addEventListener('submit', handleImportSubmit);
            }

            const modalBackdrop = document.querySelector('#importModal .import-modal__backdrop');
            if (modalBackdrop) {
                modalBackdrop.addEventListener('click', closeImportModal);
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.generate-results-link').forEach(function (link) {
                link.addEventListener('click', function (event) {
                    const url = link.getAttribute('href');
                    if (!url) {
                        return;
                    }
                    event.preventDefault();
                    const popup = window.open(url, '_blank', 'noopener');
                    if (!popup) {
                        window.location.href = url;
                        return;
                    }
                    popup.focus();
                });
            });
        });
    </script>
    <script>
        // Force reload when page is restored from back/forward cache
        window.addEventListener('pageshow', function (e) {
            const nav = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation')[0] : null;
            const isBack = (nav && nav.type === 'back_forward');
            if (e.persisted || isBack) {
                window.location.reload();
            }
        });
    </script>
    
</body>
</html>
