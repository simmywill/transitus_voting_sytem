<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .slideshow-container {
            position: relative;
            width: 80%;
            margin: auto;
            text-align: center;
        }

        .segment-slide {
            display: none;
        }

        .candidate-row {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .chart-container {
            width: 80%;
            margin: auto;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .controls button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }

        /* Show winner tab and winner display */
        .show-winner-btn {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
        }

        .winner-container {
            text-align: center;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed; /* Full-screen effect */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            visibility: hidden; /* Hidden by default */
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }

        .winner-container.show {
            visibility: visible;
            opacity: 1;
        }

        .winner-image {
            width: 60%;
            max-width: 400px;
            transition: transform 1s ease-in-out; /* This line ensures the zoom effect */
        }

        .bouncing {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0); }
        }
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .winner-image {
                width: 80%;
                max-width: 300px;
            }
        }

        /* Winner button style */
        .winner-button {
            background-color: green;
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* Close button style */
        .close-winner-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: red;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

    </style>
    <link rel="stylesheet" href="{% static 'leaderboard.css' %}?v={% now 'U' %}">
    <!-- <link href="{% static 'style.css' %}?v={% now 'U' %}" rel="stylesheet">  Link to your CSS -->
    <script src="{% static 'leaderboard.js' %}" defer></script>
</head>
<body>
    <div id="slideshow-container" class="slideshow-container">
        {% for segment in tally %}
        <div class="segment-slide" id="segment-{{ segment.segment_id }}">
            <h1>Results for {{ segment.name }}</h1>
            
            <!-- Show Winner Tab -->
            <button class="show-winner-btn" onclick="showWinner('{{ segment.segment_id }}')">Show Winner</button>

            <div class="winner-container" id="winner-container-{{ segment.segment_id }}">
                <button class="close-winner-btn" onclick="closeWinner('{{ segment.segment_id }}')">X</button>
                <div id="winner-name-{{ segment.segment_id }}" class="winner-name winner-button"></div>
                <img id="winner-image-{{ segment.segment_id }}" src="" alt="Winner Image" class="winner-image" />
                <div id="winner-votes-{{ segment.segment_id }}" class="winner-votes"></div>
            </div>

            <div class="leaderboard-container">
                <div class="leaderboard-title">üèÅ Candidate Leaderboard üèÅ</div>
                <div class="leaderboard" id="leaderboard-{{ segment.segment_id }}" data-segment="{{ segment.segment_id }}">
                    {% for candidate in segment.candidates %}
                    <div class="candidate-row"
                         data-votes="{{ candidate.votes }}"
                         data-name="{{ candidate.name }}"
                         id="candidate-{{ candidate.id }}">
                        <div class="rank" id="position-{{ candidate.id }}"></div>
                        <div class="avatar"><img src="{{ candidate.photo_url }}" alt="photo"></div>
                        <div class="name">{{ candidate.name }}</div>
                        <div class="votes" id="votes-{{ candidate.id }}">0</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="chart-container">
                <canvas id="chart-{{ segment.segment_id }}"></canvas>
            </div>
        </div>
        {% endfor %}
        
        <div class="controls">
            <button id="prev-button">Previous</button>
            <button id="next-button">Next</button>
        </div>
    </div>

    <script>
        let voteData;
        document.addEventListener("DOMContentLoaded", () => {
            voteData = JSON.parse('{{ segments_json|escapejs }}'); // Ensure JSON safety
            const segments = document.querySelectorAll(".segment-slide");
            const prevButton = document.getElementById("prev-button");
            const nextButton = document.getElementById("next-button");
            let currentSegmentIndex = 0;
            const charts = [];

            function showSegment(index) {
                segments.forEach(segment => (segment.style.display = "none"));
                const currentSegment = segments[index];
                currentSegment.style.display = "block";

                const leaderboard = currentSegment.querySelectorAll(".candidate-row");
                gsap.fromTo(
                    leaderboard,
                    { opacity: 0, y: 50 },
                    { opacity: 1, y: 0, duration: 1, stagger: 0.2 }
                );

                const candidates = voteData[index].candidates;
                candidates.forEach((candidate, i) => {
                    animateVoteCount(candidate.votes, `votes-${candidate.id}`);
                    document.getElementById(`position-${candidate.id}`).textContent = `${i + 1}`;
                });

                if (!charts[index]) {
                    const ctx = document
                        .getElementById(`chart-${voteData[index].segment_id}`)
                        .getContext("2d");
                    charts[index] = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: candidates.map(c => c.name),
                            datasets: [
                                {
                                    label: "Votes",
                                    data: candidates.map(c => c.votes),
                                    backgroundColor: ["#ff6384", "#36a2eb", "#ffce56", "#4bc0c0", "#9966ff"]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                } else {
                    charts[index].data.datasets[0].data = candidates.map(c => c.votes);
                    charts[index].update();
                }
            }

            function animateVoteCount(target, elementId) {
                let current = 0;
                const increment = Math.ceil(target / 100);
                const element = document.getElementById(elementId);
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = current;
                }, 20);
            }

            prevButton.addEventListener("click", () => {
                currentSegmentIndex = (currentSegmentIndex - 1 + segments.length) % segments.length;
                showSegment(currentSegmentIndex);
            });

            nextButton.addEventListener("click", () => {
                currentSegmentIndex = (currentSegmentIndex + 1) % segments.length;
                showSegment(currentSegmentIndex);
            });

            showSegment(0);
        });
        function showWinner(segmentId) {
            const segmentData = voteData.find(segment => segment.segment_id === parseInt(segmentId, 10));
            if (!segmentData || !segmentData.winner) {
                alert("No winner for this segment.");
                return;
            }
            const winner = segmentData.winner;

            // Display winner's image and votes
            const winnerImage = document.getElementById(`winner-image-${segmentId}`);
            const winnerName = document.getElementById(`winner-name-${segmentId}`);
            const winnerVotes = document.getElementById(`winner-votes-${segmentId}`);
            const winnerContainer = document.getElementById(`winner-container-${segmentId}`);

            winnerImage.src = winner.photo_url;
            winnerName.textContent = winner.name;
            winnerVotes.textContent = `Votes: ${winner.votes}`;

            // Show the winner container
            winnerContainer.classList.add('show');

            // Apply bouncing and zoom effect
            winnerImage.classList.add('bouncing');
            gsap.killTweensOf(winnerImage);
            gsap.to(winnerImage, { 
                scale: 1.2, 
                duration: 1, 
                yoyo: true, 
                repeat: -1 
            });
        }

        function closeWinner(segmentId) {
            const winnerContainer = document.getElementById(`winner-container-${segmentId}`);
            winnerContainer.classList.remove('show'); // Remove the 'show' class to hide the winner container

            // You can also stop the animation here if needed, for example, by resetting the image class
            const winnerImage = document.getElementById(`winner-image-${segmentId}`);
            gsap.killTweensOf(winnerImage);
            winnerImage.style.transform = "";
            winnerImage.classList.remove('bouncing');
        }
    </script>
</body>
</html>
