<style>
    
    .hidden { display: none; }

    /* Arrow tips */
    .arrow_tip_container {
        position: relative;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }
    .arrow_tip {
        position: static;
        background: transparent;
        color: #6b7280; /* muted gray */
        padding: 0;
        border-radius: 0;
        font-size: 0.9rem;
        line-height: 1.2;
        white-space: nowrap;
        opacity: 1; /* always visible */
        transform: none;
        transition: none;
        pointer-events: auto;
    }
    .arrow_tip.show { /* class toggled by JS, kept for compatibility */
        opacity: 1;
        transform: none;
    }

    /* Pulse effect for arrow */
    .pulse {
        animation: pulseAnim 1.2s infinite;
    }
    @keyframes pulseAnim {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    /* Swipe overlay tip */
    .swipe-overlay {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.95rem;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
        z-index: 10;
    }
    .swipe-overlay.active {
        opacity: 1;
    }

    /* Swipe hand animation */
    /* Swipe hand animation */
    /* Swipe hand animation */
/* Swipe hand animation */
.swipe-hint {
    position: absolute;
    inset: auto 0 0 0;       /* stretch full width along the row */
    display: flex;
    justify-content: flex-end; /* start on the right edge */
    pointer-events: none;
    font-size: clamp(2rem, 5vw, 3rem); /* Responsive size */
    opacity: 0;
    animation: swipeFade 6s ease forwards;
    z-index: 1000;
}

/* Hand emoji pointing finger with wider motion */
.hand {
    display: block;
    width: 100%;            /* use full row width for motion */
    text-align: right;      /* start from the rightmost edge */
    font-size: 2.5rem;      /* Adjust size */
    animation: swipeMotion 3.2s ease-in-out 3; /* sweep across 3 times, slower */
}

/* Widened horizontal swipe */
@keyframes swipeMotion {
    0%   { transform: translateX(0); opacity: 1; }
    10%  { opacity: 1; }
    50%  { transform: translateX(-85%); opacity: 1; }  /* sweep almost to left edge */
    90%  { transform: translateX(0); opacity: 1; }      /* glide back to right edge */
    100% { transform: translateX(0); opacity: 0; }      /* fade before restart */
}

/* Fade in/out animation for hand */
@keyframes swipeFade {
    0%, 90%, 100% { opacity: 0; }
    10%, 70% { opacity: 1; }
}

/* Vote confirmation overlay */
.confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 2000;
}

.confirm-overlay.show {
    display: flex;
}

.confirm-card {
    width: min(520px, 92vw);
    background: linear-gradient(135deg, #f8fff9, #eefcf3);
    border: 1px solid rgba(34, 197, 94, 0.35);
    border-radius: 18px;
    box-shadow:
        0 18px 42px rgba(12, 18, 32, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    color: #0f172a;
    padding: 22px 24px;
}

.confirm-card h2 {
    margin: 0 0 8px;
    color: #0f172a;
    font-size: 1.2rem;
    font-weight: 700;
}

.confirm-card p {
    margin: 0 0 18px;
    color: #1f2937;
    line-height: 1.5;
}

.confirm-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-end;
}

.confirm-btn {
    border: none;
    border-radius: 12px;
    font-weight: 700;
    padding: 12px 16px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.15s ease;
}

.confirm-yes {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: #f8fafc;
    box-shadow: 0 12px 26px rgba(22, 163, 74, 0.25);
}

.confirm-yes:hover { filter: brightness(1.05); transform: translateY(-1px); }

.confirm-no {
    background: #ffffff;
    color: #0f172a;
    border: 1px solid rgba(15, 23, 42, 0.15);
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
}

.confirm-no:hover { filter: brightness(0.98); transform: translateY(-1px); }

    
</style>
</style>
<head>
    {% load static %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'style.css' %}?v={% now 'U' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<div class="voting_page_container">
    <h2 class="voting_page_header">{{ segment.name }}</h2>
    {% if current_segment and total_segments %}
    <div class="step-indicator">Segment {{ current_segment }} of {{ total_segments }}</div>
    {% else %}
    <div class="step-indicator">Step 1 of 4</div>
    {% endif %}
    <div class="voting_instruction tip-box">
        <div class="tip-icon">ðŸ’¡</div>
        <ul class="tip-list">
            <li>Tap a candidate to select.</li>
            <li>Swipe left/right to see more candidates.</li>
            <li>Use the arrows below to move between sections.</li>
            <li>Press VOTE when all sections are complete.</li>
        </ul>
    </div>
    {% if segment.candidates.count > 4 %}
        <!-- Swipe overlay tip -->
        <div class="swipe-overlay" id="swipeOverlay">
            ðŸ‘‰ Swipe left or right to see more candidates
        </div>
       
    {% endif %}
    <div class="voting_page_candidates" id="candidatesWrapper">
        {% csrf_token %}
        {% for candidate in segment.candidates.all %}
            <div class="voting_page_candidate" 
                id="candidate-{{ candidate.id }}" 
                data-candidate-id="{{ candidate.id }}" 
                data-segment-id="{{ segment.id }}" 
                onclick="selectCandidate('{{ candidate.id }}', '{{ segment.id }}')">
                {% if candidate.photo %}
                <img src="{{ candidate.photo.url }}" alt="{{ candidate.name }}"
                     loading="lazy"
                     onerror="this.onerror=null; this.src='{% static 'placeholder.png' %}';" />
                {% else %}
                <img src="{% static 'placeholder.png' %}" alt="{{ candidate.name }}" loading="lazy" />
                {% endif %}
                <p>{{ candidate.name }}</p>
                <input type="radio" name="candidate" value="{{ candidate.id }}" class="hidden" />
                <div class="voting_page_tick">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
            </div>
        {% endfor %}

        {% if segment.candidates.count > 4 %}
         <!-- Swipe hand hint -->
         <div class="swipe-hint" id="swipeHint">
            <span class="hand">ðŸ‘ˆ</span>
        </div>
        {%endif%}
    </div>

    {% if segment.candidates.count > 4 %}
    <div class="scroll-hint">Swipe left/right to see more candidates â†’</div>
    {% endif %}

    {% if completed_segments or completed_segments == 0 %}
    <div class="progress-summary">Segments completed: {{ completed_segments }} of {{ total_segments|default:"?" }}</div>
    {% else %}
    {% endif %}

    <div class="voting_page_navigation">
        {% if current_segment > 1 %}
        <div class="arrow_tip_container">
            <a href="{% url 'bbs_ballot_entry' session_uuid=session_uuid %}?segment={{ current_segment|add:-1 }}"
               class="voting_navigation_button voting_navigation_previous">
               <i class="bi bi-caret-left-fill"></i>
            </a>
            <span class="arrow_tip">Click to go back</span>
        </div>
        {% endif %}
        
        {% if current_segment < total_segments %}
        <div class="arrow_tip_container">
            <a href="{% url 'bbs_ballot_entry' session_uuid=session_uuid %}?segment={{ current_segment|add:1 }}"
               class="voting_navigation_button voting_navigation_next pulse">
               <i class="bi bi-caret-right-fill"></i>
            </a>
            <span class="arrow_tip">Click to go next</span>
        </div>
        {% else %}
        <button class="vote-button" onclick="confirmVote()">Vote</button>
        {% endif %}
    </div>
</div>
    
    
    
</div>

<!-- Vote confirmation overlay -->
<div class="confirm-overlay" id="vote-confirm-overlay" aria-hidden="true">
  <div class="confirm-card" role="dialog" aria-modal="true" aria-labelledby="confirm-vote-title">
    <h2 id="confirm-vote-title">Confirm your vote</h2>
    <p>Are you sure you want to submit your selections?</p>
    <div class="confirm-actions">
      <button type="button" class="confirm-btn confirm-yes" id="confirm-yes-btn">Yes</button>
      <button type="button" class="confirm-btn confirm-no" id="confirm-no-btn">No, I want to change my votes</button>
    </div>
  </div>
</div>



<script>
    const session_uuid = "{{ session_uuid }}";
    const segmentIds = JSON.parse('{{ segment_ids_json|escapejs }}');
</script>

<script>



const legacyStorageKey = "selectedVotes";
const storageKey = `selectedVotes_${session_uuid}`;
const segmentIdStrings = segmentIds.map(id => id.toString());
let selectedVotes = {};
let isSubmitting = false;

function persistSelections() {
    try {
        localStorage.setItem(storageKey, JSON.stringify(selectedVotes));
    } catch (e) {
        // ignore quota/storage errors
    }
}

function loadSelections() {
    let raw = null;
    try {
        raw = localStorage.getItem(storageKey);
        if (!raw) {
            const legacy = localStorage.getItem(legacyStorageKey);
            if (legacy) {
                raw = legacy;
                localStorage.setItem(storageKey, legacy);
                localStorage.removeItem(legacyStorageKey);
            }
        }
        selectedVotes = raw ? JSON.parse(raw) || {} : {};
    } catch (e) {
        selectedVotes = {};
    }

    const allowed = new Set(segmentIdStrings);
    let mutated = false;
    Object.keys(selectedVotes).forEach((segId) => {
        if (!allowed.has(segId.toString())) {
            delete selectedVotes[segId];
            mutated = true;
        }
    });
    if (mutated) {
        persistSelections();
    }
}

function hasSelectionsForAllSegments() {
    return segmentIdStrings.every((segId) =>
        Object.prototype.hasOwnProperty.call(selectedVotes, segId)
    );
}

function openConfirmOverlay() {
    const overlay = document.getElementById('vote-confirm-overlay');
    if (overlay) {
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
    }
}

function closeConfirmOverlay() {
    const overlay = document.getElementById('vote-confirm-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
    }
}

loadSelections();

function selectCandidate(candidateId, segmentId) {
    // Update the selected vote for the given segment
    selectedVotes[segmentId.toString()] = candidateId; 
    persistSelections();

    // Remove 'selected' class only for candidates in the same segment
    document.querySelectorAll(`.voting_page_candidate[data-segment-id="${segmentId}"]`)
        .forEach((el) => el.classList.remove('selected'));

    // Add the 'selected' class to the selected candidate
    const candidate = document.getElementById(`candidate-${candidateId}`);
    if (candidate) {
        candidate.classList.add('selected');
    }
}

window.onload = function() {
    loadSelections();
    // Apply the 'selected' class to previously selected candidates
    for (const [segmentId, candidateId] of Object.entries(selectedVotes)) {
        const candidateElement = document.getElementById(`candidate-${candidateId}`);
        if (candidateElement) {
            candidateElement.classList.add('selected');
        }
    }

        // Arrow tips fade in/out
    document.querySelectorAll('.arrow_tip').forEach((tip) => {
        tip.classList.add('show');
        setTimeout(() => tip.classList.remove('show'), 4000);
    });

    // Swipe instructions if overflow
    const wrapper = document.getElementById("candidatesWrapper");
    const overlay = document.getElementById("swipeOverlay");
    const handHint = document.getElementById("swipeHint");

    if (wrapper && wrapper.scrollWidth > wrapper.clientWidth) {
        if (overlay) {
            overlay.classList.add("active");
            setTimeout(() => overlay.classList.remove("active"), 3500);
        }
        if (handHint) {
            setTimeout(() => {
                handHint.style.opacity = "1";
            }, 3500);
            setTimeout(() => {
                handHint.style.opacity = "0";
            }, 9000);
        }
        wrapper.addEventListener("scroll", () => {
            if (overlay) overlay.classList.remove("active");
            if (handHint) handHint.style.opacity = "0";
        }, { once: true });
    }

    const yesBtn = document.getElementById('confirm-yes-btn');
    const noBtn = document.getElementById('confirm-no-btn');
    if (yesBtn) yesBtn.addEventListener('click', submitVotes);
    if (noBtn) noBtn.addEventListener('click', closeConfirmOverlay);
};




function confirmVote() {
    // Check if all segments have selections
    if (!hasSelectionsForAllSegments()) {
        alert("Please make selections for all segments before voting.");
        return;
    }
    openConfirmOverlay();
}

function submitVotes() {
    if (isSubmitting) return;
    if (!hasSelectionsForAllSegments()) {
        alert("Please make selections for all segments before voting.");
        return;
    }
    const pairs = segmentIdStrings.map((segId) => [
        parseInt(segId, 10),
        parseInt(selectedVotes[segId], 10)
    ]);
    const payload = { session_uuid: session_uuid, choices: pairs };
    closeConfirmOverlay();
    isSubmitting = true;
    fetch(`/api/cast`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value
        },
        body: JSON.stringify(payload),
    }).then(async (response) => {
        const data = await response.json().catch(() => ({}));
        if (response.ok && data.ok) {
            const receipt = data.receipt || "";
            try {
                localStorage.setItem("receiptSelections", JSON.stringify(selectedVotes));
                localStorage.setItem("receiptCode", receipt);
            } catch (e) { /* ignore storage issues */ }
            localStorage.removeItem(storageKey);
            localStorage.removeItem(legacyStorageKey);
            window.location.href = "/thanks/" + session_uuid + "/";
        } else {
            throw new Error(data.error || "Submit failed");
        }
    }).catch((error) => { alert(error.message); })
    .finally(() => { isSubmitting = false; });
}

</script>
