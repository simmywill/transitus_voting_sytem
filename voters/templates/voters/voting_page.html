<style>
    .hidden {
        display: none;
    }
</style>
<head>
    {% load static %}
    <link href="{% static 'style.css' %}?v={% now 'U' %}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<div class="voting_page_container">
    <h2 class="voting_page_header">{{ segment.name }}</h2>
    <div class="voting_page_candidates">
        {% csrf_token %}
        {% for candidate in segment.candidates.all %}
        <div class="voting_page_candidate {% if candidate.id == selected_candidate_id %}selected{% endif %}" id="candidate-{{ candidate.id }}" onclick="selectCandidate('{{ candidate.id }}')">
            <img src="{{ candidate.photo.url }}" alt="{{ candidate.name }}" />
            <p>{{ candidate.name }}</p>
            <input type="radio" name="candidate" value="{{ candidate.id }}" class="hidden {% if candidate.id == selected_candidate_id %}checked{% endif %}" />
            <div class="voting_page_tick">
                <i class="bi bi-check-circle-fill"></i>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="voting_page_navigation">
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="candidate_id" value="{{ selected_candidate_id }}">
            <input type="hidden" name="voter_id" value="{{ voter_id }}">
            {% if current_segment > 1 %}
            <button class="next-button" formaction="{% url 'voter_session' session_uuid=session_uuid voter_id=voter_id %}?segment={{ current_segment|add:-1 }}">Previous</button>
            {% endif %}
            {% if current_segment < total_segments %}
            <button class="next-button" formaction="{% url 'voter_session' session_uuid=session_uuid voter_id=voter_id %}?segment={{ current_segment|add:1 }}">Next</button>
            {% else %}
            <button formaction="{% url 'submit_vote' session_uuid=session_uuid voter_id=voter_id %}">Vote</button>
            {% endif %}
        </form>
    </div>
</div>

<script>
let selectedCandidates = {};

function selectCandidate(candidateId) {
    // Highlight the selected candidate
    document.querySelectorAll('.voting_page_candidate').forEach((el) => el.classList.remove('selected'));
    const candidate = document.getElementById(`candidate-${candidateId}`);
    candidate.classList.add('selected');

    // Update the hidden input with the selected candidate ID
    document.querySelector('input[name="candidate_id"]').value = candidateId;

    // Store selection in memory
    const segment = "{{ segment.name }}";  // Ensure segment name is a string
    selectedCandidates[segment] = candidateId;
}

function navigateSegment(direction) {
    const form = document.querySelector('form');
    const currentSegmentInput = document.createElement('input');
    currentSegmentInput.type = 'hidden';
    currentSegmentInput.name = 'segment';
    currentSegmentInput.value = direction === 'next' ? "{{ current_segment|add:1 }}" : "{{ current_segment|add:-1 }}";

    form.appendChild(currentSegmentInput);

    // Send the selected vote to the backend
    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
    })
    .then((response) => response.json())  // Process the backend response as needed
    .then((data) => {
        // Update UI based on the new segment (e.g., update candidates, current segment info)
        console.log('Segment changed successfully', data);
    })
    .catch((error) => {
        alert('Error while changing segment: ' + error.message);
    });
}

function confirmVote() {
    // Check if all segments have selections
    if (Object.keys(selectedCandidates).length < "{{ total_segments }}") {
        alert("Please make selections for all segments before voting.");
        return;
    }

    // Confirm before submitting
    if (confirm("Are you sure? After this, there is no turning back.")) {
        // Prepare the data to send
        const voteData = {
            csrfmiddlewaretoken: document.querySelector('[name="csrfmiddlewaretoken"]').value,
            votes: selectedCandidates,
        };

        // Send the data to the backend
        fetch("{% url 'submit_vote' session_uuid=session_uuid voter_id=voter_id %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(voteData),
        })
        .then((response) => {
            if (response.ok) {
                alert("Your votes have been successfully submitted!");
                window.location.href = "{% url 'voter_session' session_uuid=session_uuid voter_id=voter_id %}?review=true";
            } else {
                throw new Error("Failed to submit your votes. Please try again.");
            }
        })
        .catch((error) => {
            alert(error.message);
        });
    }
}
</script>
